<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      table,
      th,
      td {
        border: 1px solid black;
        border-collapse: collapse;
      }
      th {
        padding: 5px;
      }
      td {
        text-align: right;
        padding-right: 5px;
      }
    </style>
  </head>
  <body>
    <h2>學生成績總表</h2>
    <div id="content"></div>

    <script>
      studentGrades = [
        { id: "s123456", records: ["80", "80", "80"] },
        { id: "s124578", records: ["80", "91", "70"] },
        { id: "s124582", records: ["90", "80", "70"] },
        { id: "s124588", records: ["70", "89", "80"] },
        { id: "s125699", records: ["75", "75", "60"] },
      ];

      tableTitles = ["ID Number", "Science", "Math", "程式設計", "平均成績"];

      displayGrades(studentGrades);

      function displayGrades(data) {
        // Convert data to 2d array
        var array2d = genArr2d(data);

        // Create table dom
        var htmlDom = arr2dToHtmlTableDom(array2d, tableTitles, "");

        //console.log(htmlDom.outerHTML);
        document.getElementById("content").appendChild(htmlDom);
      }
      
      // Function to create 2d array from table-like data
      function genArr2d(table) {
        var datarows = [];
        var courseSums = [0, 0, 0];

        for (var i = 0, tlen = table.length; i < tlen; i++) {
          var row = [];
          // 取得學號
          row.push(table[i]["id"]);
          let sum = 0;
          let recs = table[i].records;
          // 取得各科成績
          for (var j = 0, len = recs.length; j < len; j++) {
            row.push(recs[j]);
            courseSums[j] += parseInt(recs[j]);
            sum += parseInt(recs[j]);
          }
          
          // 取得平均成績
          let avg = (sum / len).toFixed(2); // student average
          row.push(avg);
          datarows.push(row);
        }
        
        // 照學生平均成績遞減排序
        datarows.sort( (a, b) => b[4] > a[4] ? 1 : -1 );
        
        // 創建課程平均列
        row = [""];  // 學號格 空白

        // add course average
        for (var k = 0; k < courseSums.length; k++) {
          row.push((courseSums[k] / tlen).toFixed(2));
        }

        row.push("");  // 最後一格 空白
        datarows.push(row);

        return datarows;
      }

      /* Create Table with DOM elements */
      function arr2dToHtmlTableDom(arr2d, columns, capString) {
        var tableDom = document.createElement("table");
        var tableCaption = document.createElement("caption");
        var captionText = document.createTextNode(capString);
        tableCaption.appendChild(captionText);
        tableDom.appendChild(tableCaption);

        // Set multiple styles in a single statement
        // tableDom.style.cssText = "width: 100%; margin: 10px auto;";
        // tableHtml.setAttribute("style", "color:red; border: 1px solid blue;");

        if (columns.length > 0) {
          var tableTr = document.createElement("tr");

          for (let i = 0; i < columns.length; i++) {
            var tableTh = document.createElement("th");
            var tableThContext = document.createTextNode(columns[i]);
            tableTh.appendChild(tableThContext);
            tableTr.appendChild(tableTh);
          }

          tableDom.appendChild(tableTr);
        }

        // Add data rows
        for (let i = 0, rowNum = arr2d.length; i < rowNum; i++) {
          tableTr = document.createElement("tr");

          for (let j = 0, row = arr2d[i]; j < row.length; j++) {
            var tableTd = document.createElement("td");
            var tableTdContext = document.createTextNode(row[j]);
            tableTd.appendChild(tableTdContext);
            tableTr.appendChild(tableTd);
          }

          tableDom.appendChild(tableTr);
        }

        console.log(tableDom.outerHTML);
        return tableDom;
      }
    </script>
  </body>
</html>

<!-- avg = courses[i].reduce(function(sum, value) {return sum+value;})/courses[i].length; -->
